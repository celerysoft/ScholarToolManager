{% extends '__base__.html' %}

{% block script %}
    <script>
        $(function () {
            let userId = '{{ session.user.id }}';

            let vm_my_product = new Vue({
                el: "#vm_my_product",
                data: {
                    products: [],
                    page: 1,
                    loadMoreVisible: false
                },
                methods: {
                    loadMoreProduct: function () {
                        this.page++;
                        this.getProduct()
                    },
                    getProduct: function () {
                        httpGet('/api/service', { user_id: userId, page: vm_my_product.$data.page, page_size: 10 }, function (error, data, jqXHR) {
                            $('#loading').hide();

                            if (error) {
                                return mdui.alert(error.message);
                            }

                            console.log(data);

                            vm_my_product.$data.loadMoreVisible = data.page < data.max_page;

                            let length = data.service.length;
                            for (let i = 0; i < length; i++) {
                                let service = data.service[i];
                                service.balance = ((service.package - service.usage) / 1024 / 1024).toFixed(2);
                                service.status_str = service.alive ? '有效' : '失效';
                                service.detail_url = '/product/detail/' + service.id;
                            }
                            vm_my_product.$data.products = vm_my_product.$data.products.concat(data.service);
                        })
                    }
                }
            });

            vm_my_product.getProduct();
        });
    </script>

    <script src="{{ static_route }}/static/js/scroll_to_top.js"></script>
{% endblock %}

{% block under_toolbar %}
    <div id="loading" class="mdui-progress">
        <div class="mdui-progress-indeterminate"></div>
    </div>
{% endblock %}

{% block content %}
    <div id="vm_my_product">
        <div v-if="products.length > 0" class="mdui-table-fluid" style="margin: 16px 0;">
            <table class="mdui-table">
                <thead>
                <tr>
                    <th>学术名</th>
                    <th>学术端口</th>
                    <th>剩余学术点</th>
                    <th>学术状态</th>
                </tr>
                </thead>
                <tbody class="mdui-typo">
                <tr v-for="product in products">
                    <td><a :href="product.detail_url">{{product.title}}</a></td>
                    <td>{{product.port}}</td>
                    <td>{{product.balance}} M</td>
                    <td>{{product.status_str}}</td>
                </tr>
                </tbody>
            </table>

             <div v-if="loadMoreVisible" class="mdui-text-center" style="margin: 16px 0;">
                <button v-on:click="loadMoreProduct" class="mdui-btn">点击加载更多</button>
            </div>
        </div>
        <div class="mdui-typo" style="margin: 32px 0;" v-else>
            暂无学术，去<a href="/product/create/">订阅</a>
        </div>
    </div>

    {% include '__scroll_to_top_button_base__.html' %}
{% endblock %}